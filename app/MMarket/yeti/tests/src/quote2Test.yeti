// Copyright 07-May-2020 ÂºDeme
// GNU General Public License - V3 <http://www.gnu.org/licenses/>

module quote2Test;

load es.dm.std;
load es.dm.assert;
quote = load data.quote;

(
  mkq s = optGet (quote.fromStr s);
{
  run () =
    println "Quote2 test:";

    qs1 =
      [ mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false",
        mkq "20190203:2.0500:2.0700:3.0000:2.0000:234111:false",
        mkq "20190201:2.0500:2.0700:3.0000:2.0000:234111:false"
      ];
    qs2 =
      [ mkq "20190204:2.0512:2.0700:3.0000:2.0000:234111:false",
        mkq "20190202:2.0500:2.0722:3.0000:2.0000:234111:false",
        mkq "20190201:2.0500:2.0700:3.0000:2.0200:234111:false"
      ];
    qs3 =
      [ mkq "20190204:2.0500:2.0700:3.0000:2.2000:234111:false",
        mkq "20190203:2.0500:2.0700:3.1500:2.0000:234111:false",
        mkq "20190202:2.0500:2.0722:3.1500:2.0000:234111:false",
        mkq "20190201:2.0500:2.0700:3.0000:2.0300:234111:false"
      ];

    aqs = array [qs1, qs2];
    r = array (quote.unify aqs 1);
    eq (length r) 3;
    eq r[0] (mkq "20190204:2.0512:2.0700:3.0000:2.0000:234111:false");
    eq r[1] (mkq "20190202:2.0500:2.0722:3.0000:2.0000:234111:false");
    eq r[2] (mkq "20190201:2.0500:2.0700:3.0000:2.0200:234111:false");

    aqs = array [qs2, qs1];
    r = array (quote.unify aqs 0);
    eq (length r) 3;
    eq r[0] (mkq "20190204:2.0512:2.0700:3.0000:2.0000:234111:false");
    eq r[1] (mkq "20190202:2.0500:2.0722:3.0000:2.0000:234111:false");
    eq r[2] (mkq "20190201:2.0500:2.0700:3.0000:2.0200:234111:false");

    aqs = array [qs3, qs2, qs1];
    r = array (quote.unify aqs 1);
    eq (length r) 4;
    eq r[0] (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false");
    eq r[1] (mkq "20190203:2.0500:2.0700:3.0000:2.0000:234111:false");
    eq r[2] (mkq "20190202:2.0500:2.0722:3.0000:2.0000:234111:false");
    eq r[3] (mkq "20190201:2.0500:2.0700:3.0000:2.0200:234111:false");

    {error, q} =
      quote.correct1 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false");
    eq error "";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false");

    {error, q} =
      quote.correct1 (mkq "20190204:3.0500:2.0700:3.0000:2.0000:234111:false");
    eq error "Open > Max";
    eq q (mkq "20190204:3.0500:2.0700:3.0500:2.0000:234111:true");

    {error, q} =
      quote.correct1 (mkq "20190204:1.0500:2.0700:3.0000:2.0000:234111:false");
    eq error "Open < Min";
    eq q (mkq "20190204:1.0500:2.0700:3.0000:1.0500:234111:true");

    {error, q} =
      quote.correct1 (mkq "20190204:2.0500:3.0700:3.0000:2.0000:234111:false");
    eq error "Close > Max";
    eq q (mkq "20190204:2.0500:3.0700:3.0700:2.0000:234111:true");

    {error, q} =
      quote.correct1 (mkq "20190204:2.0500:1.0700:3.0000:2.0000:234111:false");
    eq error "Close < Min";
    eq q (mkq "20190204:2.0500:1.0700:3.0000:1.0700:234111:true");

    {error, q} =
      quote.correct1 (mkq "20190204:2.0500:1.0700:3.0000:2.0000:234111:true");
    eq error "";
    eq q (mkq "20190204:2.0500:1.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:1.9500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:1.9500:2.0700:3.0000:2.0000:234111:false");
    eq error "Open < Min";
    eq q (mkq "20190204:1.9500:2.0700:3.0000:1.9500:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:2.0500:3.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:3.0700:3.0000:2.0000:234111:false");
    eq error "Close > Max";
    eq q (mkq "20190204:2.0500:3.0700:3.0700:2.0000:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:2.0500:1.9700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false");
    eq error"Close < Min";
    eq q (mkq "20190204:2.0500:1.9700:3.0000:1.9700:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:2.0500:1.0700:3.0000:2.0000:234111:true")
                     (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false");
    eq error "";
    eq q (mkq "20190204:2.0500:1.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:3.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:3.0500:2.0700:3.1000:2.0000:234111:false");
    eq error "Open > Max";
    eq q (mkq "20190204:3.0000:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:1.9500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:1.9500:2.0700:3.0000:2.1000:234111:false");
    eq error "Open < Min";
    eq q (mkq "20190204:2.0000:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:2.0500:3.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:3.0700:3.1000:2.0000:234111:false");
    eq error "Close > Max";
    eq q (mkq "20190204:2.0500:3.0000:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct2 (mkq "20190204:2.0500:1.9700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:1.9700:3.0000:2.1000:234111:false");
    eq error "Close < Min";
    eq q (mkq "20190204:2.0500:2.0000:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:1.0500:2.0700:3.0000:2.0000:234111:false");
    eq error "Open +20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:4.0500:2.0700:3.0000:2.0000:234111:false");
    eq error "Open -20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:1.0700:3.0000:2.0000:234111:false");
    eq error "Close +20%";
    eq q (mkq"20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:4.0700:3.0000:2.0000:234111:false");
    eq error "Close -20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:2.0700:2.0000:2.0000:234111:false");
    eq error "Max +20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:2.0700:4.0000:2.0000:234111:false");
    eq error "Max -20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:2.0700:3.0000:1.0000:234111:false");
    eq error"Min +20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:false")
                     (mkq "20190204:2.0500:2.0700:3.0000:3.0000:234111:false");
    eq error "Min -20%";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    {error, q} =
      quote.correct3 (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true")
                     (mkq "20190204:2.0500:2.0700:3.0000:3.0000:234111:false");
    eq error "";
    eq q (mkq "20190204:2.0500:2.0700:3.0000:2.0000:234111:true");

    qs1 =
      [ mkq "20190214:2.0500:2.0600:3.0000:2.0200:234111:false",
        mkq "20190213:2.0100:2.0600:3.0000:2.0200:234111:false",
        mkq "20190212:2.0500:2.0600:3.0000:2.0200:234111:true",
        mkq "20190211:2.0100:2.0600:3.0000:2.0000:234111:false",
        mkq "20190210:2.0500:3.0600:3.0000:2.0200:234111:false"
      ];

    {errors, qs} = quote.correct(qs1);
    eq (length errors) 3;
    eq (length qs) 5;
    aerrors = array errors;
    eq aerrors[0] "20190210: Close > Max";
    eq aerrors[1] "20190211: Close -20%";
    eq aerrors[2] "20190213: Open < Min";
    aqs = array qs;
    eq aqs[0] (mkq "20190214:2.0500:2.0600:3.0000:2.0200:234111:false");
    eq aqs[1] (mkq "20190213:2.0100:2.0600:3.0000:2.0100:234111:true");
    eq aqs[2] (mkq "20190212:2.0500:2.0600:3.0000:2.0200:234111:true");
    eq aqs[3] (mkq "20190211:2.0100:2.0600:3.0000:2.0000:234111:true");
    eq aqs[4] (mkq "20190210:2.0500:3.0600:3.0600:2.0200:234111:true");

    qs1 =
      [ mkq "20190214:2.0500:2.0600:3.0000:2.0200:234111:false",
        mkq "20190213:2.0100:2.0600:3.0000:2.0200:234111:false",
        mkq "20190212:2.0500:2.0600:3.0000:2.0200:234111:false",
        mkq "20190211:2.0100:2.0600:3.0000:2.0200:234111:false",
        mkq "20190210:2.0500:2.0600:3.0000:2.0200:234111:false",
        mkq "20190209:2.0100:2.0600:3.0000:2.0200:234111:false",
        mkq "20190208:2.0100:2.0600:3.0000:2.0200:234111:false"
      ];

    qs2 =
      [ mkq "20190212:2.0500:2.0700:3.0000:2.0200:234111:false",
        mkq "20190211:2.0500:2.0700:3.0000:2.0200:234111:false",
        mkq "20190210:2.0000:2.0700:3.0000:2.0200:234111:true",
        mkq "20190208:2.0000:2.0700:3.0000:2.0200:234111:true",
        mkq "20190207:2.0500:2.0700:3.0000:2.0200:234111:false",
        mkq "20190206:2.0000:2.0700:3.0000:2.0200:234111:true"
      ];

    qs3 =
      [ mkq "20190215:2.0500:2.0600:3.0000:2.0200:234111:false",
        mkq "20190214:2.0500:2.0600:3.0000:2.0200:234111:false",
        mkq "20190213:2.0100:2.0600:3.0000:2.0200:234111:false",
        mkq "20190212:2.0500:2.0700:3.0000:2.0200:234111:false",
        mkq "20190211:2.0500:2.0700:3.0000:2.0200:234111:false",
        mkq "20190210:2.0000:2.0700:3.0000:2.0200:234111:true",
        mkq "20190208:2.0500:2.0700:3.0000:2.0200:234111:false",
        mkq "20190207:2.0000:2.0700:3.0000:2.0200:234111:true",
        mkq "20190206:2.0000:2.0700:3.0000:2.0200:234111:true"
      ];

    {errors, qs} = quote.merge qs3 qs1 qs2;
    eq (length errors) 3;
    eq (length qs) 9;
    aerrors = array errors;
    eq aerrors[0] "20190215: Missing quote";
    eq aerrors[1] "20190213: Open < Min";
    eq aerrors[2] "20190209: Extra quote";
    aqs = array qs;
    eq aqs[0] (mkq "20190215:-1.0000:-1.0000:-1.0000:-1.0000:-1:true");
    eq aqs[1] (mkq "20190214:2.0500:2.0600:3.0000:2.0200:234111:false");
    eq aqs[2] (mkq "20190213:2.0100:2.0600:3.0000:2.0100:234111:true");
    eq aqs[3] (mkq "20190212:2.0500:2.0700:3.0000:2.0200:234111:false");
    eq aqs[4] (mkq "20190211:2.0500:2.0700:3.0000:2.0200:234111:false");
    eq aqs[5] (mkq "20190210:2.0000:2.0700:3.0000:2.0200:234111:true");
    eq aqs[6] (mkq "20190208:2.0000:2.0700:3.0000:2.0200:234111:true");
    eq aqs[7] (mkq "20190207:2.0500:2.0700:3.0000:2.0200:234111:false");
    eq aqs[8] (mkq "20190206:2.0000:2.0700:3.0000:2.0200:234111:true");

    println "    Finished.";
})
