// Copyright 22-May-2020 ÂºDeme
// GNU General Public License - V3 <http://www.gnu.org/licenses/>

module fleaTest;

load es.dm.std;
date = load es.dm.date;
load es.dm.assert;
flea = load data.flea.flea;

{
  run () =
    println "Flea test:";
    mins = [10, 0, 0] |> array;
    maxs = [30, 2.5, 5] |> array;
    fs = map do i:
      flea.mk "20200201" 33 i mins maxs
      done [0..99];
    for fs do f:
      eq f.date "20200201";
      eq f.cycle 33;
      f2 = flea.toJs f |> flea.fromJs;
      eq f2.date "20200201";
      eq f2.cycle 33;
      yes (flea.eq f f2)
      done;

    f = flea.mk (date.now () |> date.addDays (-20) |> date.toStr)
                33 1 mins maxs;
    ev1 = flea.evaluate f 0.6 0.2;
    f = flea.mk (date.now () |> date.addDays (-30) |> date.toStr)
                33 1 mins maxs;
    ev2 = flea.evaluate f 0.6 0.2;
    f = flea.mk (date.now () |> date.addDays (-60) |> date.toStr)
                33 1 mins maxs;
    ev3 = flea.evaluate f 0.6 0.2;

    yes (ev1 < ev2);
    yes (ev2 < ev3);

    for [0..999] do _:
      f2 = flea.mutate f "20200201" 12 2;
      eq f2.date "20200201";
      eq f2.cycle 12;
      eq f2.id 2;
      yes (not flea.eq f f2)
      done;

    println "    Finished.";
}